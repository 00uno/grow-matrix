<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GrowOps v5.0 - Command Center</title>
  <style>
    :root {
      --bg: #000;
      --text: #0F0;
      --dim: #040;
      --highlight: #0C0;
      --warn: #FF0;
      --danger: #F00;
      --border: #030;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier New', monospace;
      margin: 0;
      height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border: 1px solid var(--text);
    }

    header {
      padding: 10px 20px;
      border-bottom: 1px solid var(--text);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(0, 20, 0, 0.9);
    }

    h1 {
      margin: 0;
      font-size: 1.5rem;
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    .status-online {
      color: var(--text);
      text-shadow: 0 0 5px var(--text);
      font-weight: bold;
      margin-left: 20px;
    }

    .status-offline {
      color: #555;
      margin-left: 20px;
    }

    .config-area {
      display: flex;
      gap: 10px;
      align-items: center;
      margin-left: auto;
    }

    input[type="date"] {
      background: black;
      color: var(--text);
      border: 1px solid var(--text);
      padding: 5px;
      font-family: inherit;
    }

    .calendar-section {
      padding: 20px;
      overflow-y: auto;
      height: 100%;
    }

    .calendar-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
      font-size: 1.2rem;
      font-weight: bold;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
    }

    .day-name {
      text-align: center;
      padding: 10px;
      color: var(--highlight);
      border-bottom: 1px solid var(--border);
    }

    .day-cell {
      border: 2px solid var(--border);
      min-height: 100px;
      padding: 5px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
    }

    .day-cell:hover {
      background: rgba(0, 255, 0, 0.1);
      box-shadow: 0 0 10px var(--dim);
    }

    .day-cell.today {
      background: rgba(0, 50, 0, 0.5);
    }

    .date-number {
      font-weight: bold;
      font-size: 0.9rem;
    }

    .plant-age {
      font-size: 0.7rem;
      color: var(--highlight);
      margin-top: 2px;
    }

    .data-summary {
      margin-top: 5px;
      font-size: 9px;
      line-height: 1.3;
      flex-grow: 1;
    }

    .data-summary div {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 1px;
    }

    .env {
      color: #aaa;
    }

    .water {
      color: #0ff;
    }

    .lux {
      color: #ff0;
    }

    .notes {
      color: #0f0;
    }

    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.85);
      z-index: 999;
      align-items: center;
      justify-content: center;
    }

    .modal-overlay.active {
      display: flex;
    }

    .data-modal {
      background: black;
      border: 2px solid var(--text);
      box-shadow: 0 0 30px var(--text);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px;
    }

    .modal-header {
      font-size: 1.3rem;
      font-weight: bold;
      margin-bottom: 15px;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
      padding-bottom: 10px;
    }

    .modal-section {
      margin-bottom: 15px;
    }

    .modal-section label {
      display: block;
      margin-bottom: 5px;
      font-size: 0.85rem;
      color: var(--highlight);
    }

    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .input-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .input-wrapper span {
      font-size: 0.75rem;
      color: var(--dim);
      margin-bottom: 3px;
    }

    input[type="number"],
    input[type="text"],
    textarea {
      background: black;
      color: var(--text);
      border: 1px solid var(--text);
      padding: 8px;
      font-family: inherit;
      width: 100%;
      font-size: 0.9rem;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      box-shadow: 0 0 5px var(--highlight);
    }

    textarea {
      min-height: 80px;
      resize: vertical;
    }

    .vpd-display {
      padding: 10px;
      border: 1px solid var(--border);
      text-align: center;
      font-weight: bold;
      font-size: 1rem;
      margin-top: 5px;
    }

    .water-counter {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    input[type="checkbox"] {
      accent-color: var(--text);
      width: 18px;
      height: 18px;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-bottom: 8px;
    }

    button {
      background: black;
      color: var(--text);
      border: 1px solid var(--text);
      padding: 10px 15px;
      font-family: inherit;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
    }

    button:hover {
      background: var(--text);
      color: black;
      box-shadow: 0 0 15px var(--text);
    }

    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    .modal-actions button {
      flex: 1;
      padding: 12px;
      font-weight: bold;
    }

    .btn-secondary {
      border-color: var(--dim);
      color: var(--dim);
    }

    .btn-secondary:hover {
      background: var(--dim);
      color: black;
    }

    .sync-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 350px;
      background: black;
      border: 2px solid var(--text);
      padding: 15px;
      z-index: 100;
      box-shadow: 0 0 20px var(--text);
    }

    .sync-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 5px;
    }

    .sync-header h3 {
      margin: 0;
      font-size: 1rem;
    }

    .btn-small {
      font-size: 0.7rem;
      padding: 3px 8px;
    }

    .sync-content textarea {
      width: 100%;
      min-height: 100px;
      margin-bottom: 10px;
      font-size: 0.75rem;
      font-family: monospace;
    }

    .sync-progress {
      margin-top: 10px;
    }

    .progress-bar {
      width: 100%;
      height: 20px;
      background: black;
      border: 1px solid var(--text);
      margin-bottom: 5px;
      position: relative;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--text);
      width: 0%;
      transition: width 0.3s;
      box-shadow: 0 0 10px var(--text);
    }

    #sync-status {
      font-size: 0.8rem;
      text-align: center;
      color: var(--highlight);
    }

    #matrix-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      opacity: 0.1;
      pointer-events: none;
    }
  </style>
</head>

<body>

  <canvas id="matrix-bg"></canvas>

  <header>
    <h1>GrowOps v5.0</h1>
    <span id="db-status" class="status-offline">[ FIREBASE: INIT... ]</span>
    <div class="config-area">
      <label>GERMINATION:</label>
      <input type="date" id="germination-date">
    </div>
  </header>

  <section class="calendar-section">
    <div class="calendar-header">
      <button id="prev-month">&lt;</button>
      <span id="current-month-display">LOADING...</span>
      <button id="next-month">&gt;</button>
    </div>
    <div class="calendar-grid" id="calendar-grid"></div>
  </section>

  <div class="modal-overlay" id="modal-overlay">
    <div class="data-modal">
      <div class="modal-header" id="modal-title">DAY REPORT</div>

      <div class="modal-section">
        <label>ENVIRONMENT</label>
        <div class="input-row">
          <div class="input-wrapper">
            <span>TEMP (Â°C)</span>
            <input type="number" id="modal-temp" placeholder="24" step="0.1">
          </div>
          <div class="input-wrapper">
            <span>HUMIDITY (%)</span>
            <input type="number" id="modal-rh" placeholder="60" step="1">
          </div>
        </div>
        <div id="vpd-display" class="vpd-display">VPD: -- kPa</div>
      </div>

      <div class="modal-section">
        <label>LUX</label>
        <input type="number" id="modal-lux" list="lux-presets" placeholder="TYPE OR SELECT">
        <datalist id="lux-presets">
          <option value="3000">SEEDLING: 3k</option>
          <option value="5000">SEEDLING: 5k</option>
          <option value="8000">SEEDLING: 8k</option>
          <option value="10000">VEG: 10k</option>
          <option value="11000">VEG: 11k</option>
          <option value="12000">VEG: 12k</option>
          <option value="13000">VEG: 13k</option>
          <option value="14000">VEG: 14k</option>
          <option value="15000">VEG: 15k</option>
          <option value="18000">VEG: 18k</option>
          <option value="20000">VEG: 20k</option>
          <option value="25000">VEG: 25k</option>
          <option value="30000">VEG: 30k</option>
          <option value="40000">FLOWER: 40k</option>
          <option value="45000">FLOWER: 45k</option>
          <option value="50000">FLOWER: 50k</option>
          <option value="60000">FLOWER: 60k</option>
          <option value="70000">FLOWER: 70k</option>
        </datalist>
      </div>

      <div class="modal-section">
        <label>WATER (L)</label>
        <div class="water-counter">
          <button id="modal-add-water">+0.5L</button>
          <span id="modal-water-display">0.0 L</span>
          <button id="modal-reset-water" style="font-size:0.8rem;padding:5px;">RESET</button>
        </div>
      </div>

      <div class="modal-section">
        <label>NUTRIENTS</label>
        <div class="checkbox-label">
          <input type="checkbox" id="modal-root">
          ROOT STIMULATOR
        </div>
        <div class="checkbox-label">
          <input type="checkbox" id="modal-fert">
          FERTILIZER
        </div>
      </div>

      <div class="modal-section">
        <label>NOTES</label>
        <textarea id="modal-notes" placeholder="Observations..."></textarea>
      </div>

      <div class="modal-actions">
        <button id="copy-yesterday-btn" class="btn-secondary">COPY YESTERDAY</button>
        <button id="save-close-btn">SAVE & CLOSE</button>
      </div>
    </div>
  </div>

  <div class="sync-panel" id="sync-panel">
    <div class="sync-header">
      <h3>OFFLINE SYNC</h3>
      <button id="toggle-sync-btn" class="btn-small">HIDE</button>
    </div>

    <div id="sync-content" class="sync-content">
      <label>ESP32 FLIGHT LOG (JSON)</label>
      <textarea id="flight-log-input" placeholder='[{"timestamp":"2024-11-24","temp":25.3,"rh":65.2}, ...]'></textarea>
      <button id="inject-btn">INJECT DATA</button>

      <div id="sync-progress" class="sync-progress" style="display:none;">
        <div class="progress-bar">
          <div id="progress-fill" class="progress-fill"></div>
        </div>
        <div id="sync-status">PROCESSING...</div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBzjkda5C3__QB8jglOQK79HDfvxVZ8iGQ",
      authDomain: "grow-matrix.firebaseapp.com",
      databaseURL: "https://grow-matrix-default-rtdb.firebaseio.com",
      projectId: "grow-matrix",
      storageBucket: "grow-matrix.firebasestorage.app",
      messagingSenderId: "1004789173992",
      appId: "1:1004789173992:web:0aa39431f84cd4937c435d"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const STATE = {
      germinationDate: null,
      currentViewDate: new Date(),
      selectedDate: null,
      data: {}
    };

    const els = {
      germinationInput: document.getElementById('germination-date'),
      grid: document.getElementById('calendar-grid'),
      monthDisplay: document.getElementById('current-month-display'),
      prevBtn: document.getElementById('prev-month'),
      nextBtn: document.getElementById('next-month'),
      dbStatus: document.getElementById('db-status'),
      modalOverlay: document.getElementById('modal-overlay'),
      modalTitle: document.getElementById('modal-title'),
      modalTemp: document.getElementById('modal-temp'),
      modalRh: document.getElementById('modal-rh'),
      vpdDisplay: document.getElementById('vpd-display'),
      modalLux: document.getElementById('modal-lux'),
      modalWaterDisplay: document.getElementById('modal-water-display'),
      modalAddWaterBtn: document.getElementById('modal-add-water'),
      modalResetWaterBtn: document.getElementById('modal-reset-water'),
      modalRoot: document.getElementById('modal-root'),
      modalFert: document.getElementById('modal-fert'),
      modalNotes: document.getElementById('modal-notes'),
      copyYesterdayBtn: document.getElementById('copy-yesterday-btn'),
      saveCloseBtn: document.getElementById('save-close-btn'),
      syncPanel: document.getElementById('sync-panel'),
      toggleSyncBtn: document.getElementById('toggle-sync-btn'),
      syncContent: document.getElementById('sync-content'),
      flightLogInput: document.getElementById('flight-log-input'),
      injectBtn: document.getElementById('inject-btn'),
      syncProgress: document.getElementById('sync-progress'),
      progressFill: document.getElementById('progress-fill'),
      syncStatus: document.getElementById('sync-status')
    };

    function init() {
      setupFirebaseListener();
      renderCalendar();
      setupEventListeners();
      setupMatrixRain();
    }

    function setupFirebaseListener() {
      const dbRef = ref(db, 'growData');
      onValue(dbRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          STATE.germinationDate = data.germinationDate || null;
          STATE.data = data.data || {};
          if (STATE.germinationDate) els.germinationInput.value = STATE.germinationDate;
          renderCalendar();
        }
        els.dbStatus.innerText = "[ FIREBASE: ONLINE ]";
        els.dbStatus.className = "status-online";
      }, (error) => {
        console.error(error);
        els.dbStatus.innerText = "[ FIREBASE: ERROR ]";
        els.dbStatus.className = "status-offline";
        els.dbStatus.style.color = "red";
      });
    }

    function saveData() {
      const payload = {
        germinationDate: STATE.germinationDate,
        data: STATE.data
      };
      return set(ref(db, 'growData'), payload);
    }

    function calculateVPD(tempC, rh) {
      if (!tempC || !rh || isNaN(tempC) || isNaN(rh)) {
        return { vpd: null, status: 'unknown', color: '#555' };
      }
      const svp = 0.61078 * Math.exp((17.27 * tempC) / (tempC + 237.3));
      const avp = svp * (rh / 100);
      const vpd = svp - avp;
      let status = 'OPTIMAL';
      let color = '#00FF00';
      if (vpd < 0.4 || vpd > 1.6) {
        status = 'CRITICAL';
        color = '#FF0000';
      } else if (vpd < 0.8 || vpd > 1.2) {
        status = 'WARNING';
        color = '#FFFF00';
      }
      return { vpd: vpd.toFixed(2), status, color };
    }

    function openModal(dateStr) {
      STATE.selectedDate = dateStr;
      let age = -1;
      let ageText = "PRE-GERMINATION";
      if (STATE.germinationDate) {
        age = calculateAge(STATE.germinationDate, dateStr);
        if (age >= 0) ageText = `DAY ${age}`;
      }
      els.modalTitle.innerText = `${ageText} REPORT - ${dateStr}`;
      const dayData = STATE.data[dateStr] || { water: 0, root: false, fert: false, notes: '', temp: '', rh: '', lux: '' };
      if (!STATE.data[dateStr]) {
        STATE.data[dateStr] = { water: 0, root: false, fert: false, notes: '', temp: '', rh: '', lux: '' };
      }
      els.modalTemp.value = dayData.temp || '';
      els.modalRh.value = dayData.rh || '';
      els.modalLux.value = dayData.lux || '';
      els.modalWaterDisplay.innerText = `${(dayData.water || 0).toFixed(1)} L`;
      els.modalRoot.checked = dayData.root || false;
      els.modalFert.checked = dayData.fert || false;
      els.modalNotes.value = dayData.notes || '';
      updateVPDDisplay();
      els.modalOverlay.classList.add('active');
    }

    function closeModal() {
      els.modalOverlay.classList.remove('active');
      STATE.selectedDate = null;
    }

    function updateVPDDisplay() {
      const temp = parseFloat(els.modalTemp.value);
      const rh = parseFloat(els.modalRh.value);
      const vpdResult = calculateVPD(temp, rh);
      if (vpdResult.vpd) {
        els.vpdDisplay.innerText = `VPD: ${vpdResult.vpd} kPa [${vpdResult.status}]`;
        els.vpdDisplay.style.color = vpdResult.color;
        els.vpdDisplay.style.borderColor = vpdResult.color;
      } else {
        els.vpdDisplay.innerText = "VPD: -- kPa";
        els.vpdDisplay.style.color = '#555';
        els.vpdDisplay.style.borderColor = '#030';
      }
    }

    function saveAndClose() {
      if (!STATE.selectedDate) return;
      STATE.data[STATE.selectedDate].temp = els.modalTemp.value;
      STATE.data[STATE.selectedDate].rh = els.modalRh.value;
      STATE.data[STATE.selectedDate].lux = els.modalLux.value;
      STATE.data[STATE.selectedDate].root = els.modalRoot.checked;
      STATE.data[STATE.selectedDate].fert = els.modalFert.checked;
      STATE.data[STATE.selectedDate].notes = els.modalNotes.value;
      saveData();
      renderCalendar();
      closeModal();
    }

    function copyFromYesterday() {
      if (!STATE.selectedDate) return;
      const currentDate = new Date(STATE.selectedDate);
      currentDate.setDate(currentDate.getDate() - 1);
      const yesterdayStr = getFormattedDate(currentDate);
      const yesterdayData = STATE.data[yesterdayStr];
      if (yesterdayData) {
        els.modalTemp.value = yesterdayData.temp || '';
        els.modalRh.value = yesterdayData.rh || '';
        els.modalLux.value = yesterdayData.lux || '';
        STATE.data[STATE.selectedDate].water = yesterdayData.water || 0;
        els.modalWaterDisplay.innerText = `${STATE.data[STATE.selectedDate].water.toFixed(1)} L`;
        els.modalRoot.checked = yesterdayData.root || false;
        els.modalFert.checked = yesterdayData.fert || false;
        updateVPDDisplay();
      } else {
        alert('NO DATA FROM YESTERDAY');
      }
    }

    async function injectFlightLog() {
      const rawData = els.flightLogInput.value.trim();
      if (!rawData) {
        alert('NO DATA TO INJECT');
        return;
      }
      try {
        const logData = JSON.parse(rawData);
        if (!Array.isArray(logData)) throw new Error('Data must be an array');
        els.syncProgress.style.display = 'block';
        const totalItems = logData.length;
        let processed = 0;
        for (const entry of logData) {
          const { timestamp, temp, rh } = entry;
          if (!timestamp) continue;
          if (!STATE.data[timestamp]) {
            STATE.data[timestamp] = { water: 0, root: false, fert: false, notes: '', temp: '', rh: '', lux: '' };
          }
          if (temp !== undefined) STATE.data[timestamp].temp = temp.toFixed(1);
          if (rh !== undefined) STATE.data[timestamp].rh = rh.toFixed(1);
          processed++;
          const progress = (processed / totalItems) * 100;
          els.progressFill.style.width = `${progress}%`;
          els.syncStatus.innerText = `PROCESSING ${processed}/${totalItems}`;
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        await saveData();
        renderCalendar();
        els.syncStatus.innerText = `COMPLETE: ${processed} RECORDS INJECTED`;
        els.syncStatus.style.color = '#0F0';
        setTimeout(() => {
          els.syncProgress.style.display = 'none';
          els.progressFill.style.width = '0%';
          els.flightLogInput.value = '';
        }, 2000);
      } catch (error) {
        alert(`PARSE ERROR: ${error.message}`);
        els.syncProgress.style.display = 'none';
      }
    }

    function renderCalendar() {
      els.grid.innerHTML = '';
      const year = STATE.currentViewDate.getFullYear();
      const month = STATE.currentViewDate.getMonth();
      const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "APRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
      els.monthDisplay.innerText = `${monthNames[month]} ${year}`;
      const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
      days.forEach(d => {
        const div = document.createElement('div');
        div.className = 'day-name';
        div.innerText = d;
        els.grid.appendChild(div);
      });
      const firstDay = new Date(year, month, 1);
      const lastDay = new Date(year, month + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startDayIndex = firstDay.getDay();
      for (let i = 0; i < startDayIndex; i++) {
        const div = document.createElement('div');
        div.className = 'day-cell';
        div.style.opacity = '0.3';
        div.style.cursor = 'default';
        els.grid.appendChild(div);
      }
      const todayStr = getFormattedDate(new Date());
      for (let i = 1; i <= daysInMonth; i++) {
        const dateObj = new Date(year, month, i);
        const dateStr = getFormattedDate(dateObj);
        const dayData = STATE.data[dateStr];
        const cell = document.createElement('div');
        cell.className = 'day-cell';
        if (dateStr === todayStr) cell.classList.add('today');
        const numDiv = document.createElement('div');
        numDiv.className = 'date-number';
        numDiv.innerText = i;
        cell.appendChild(numDiv);
        if (STATE.germinationDate) {
          const age = calculateAge(STATE.germinationDate, dateStr);
          if (age >= 0) {
            const ageDiv = document.createElement('div');
            ageDiv.className = 'plant-age';
            ageDiv.innerText = `Day ${age}`;
            cell.appendChild(ageDiv);
          }
        }
        if (dayData) {
          const summaryDiv = document.createElement('div');
          summaryDiv.className = 'data-summary';
          if (dayData.temp || dayData.rh) {
            const envDiv = document.createElement('div');
            envDiv.className = 'env';
            const tempStr = dayData.temp ? `ðŸŒ¡ï¸ ${dayData.temp}Â°` : '';
            const rhStr = dayData.rh ? `ðŸ’§ ${dayData.rh}%` : '';
            envDiv.innerText = [tempStr, rhStr].filter(s => s).join(' | ');
            summaryDiv.appendChild(envDiv);
          }
          if (dayData.water > 0) {
            const waterDiv = document.createElement('div');
            waterDiv.className = 'water';
            waterDiv.innerText = `ðŸš¿ ${dayData.water.toFixed(1)}L`;
            summaryDiv.appendChild(waterDiv);
          }
          if (dayData.lux) {
            const luxDiv = document.createElement('div');
            luxDiv.className = 'lux';
            luxDiv.innerText = `âš¡ ${dayData.lux}`;
            summaryDiv.appendChild(luxDiv);
          }
          if (dayData.notes && dayData.notes.trim()) {
            const notesDiv = document.createElement('div');
            notesDiv.className = 'notes';
            notesDiv.innerText = 'ðŸ“';
            summaryDiv.appendChild(notesDiv);
          }
          cell.appendChild(summaryDiv);
          if (dayData.temp && dayData.rh) {
            const vpdResult = calculateVPD(parseFloat(dayData.temp), parseFloat(dayData.rh));
            cell.style.borderColor = vpdResult.color;
          }
        }
        cell.onclick = () => openModal(dateStr);
        els.grid.appendChild(cell);
      }
    }

    function calculateAge(germDateStr, targetDateStr) {
      const germ = new Date(germDateStr);
      const target = new Date(targetDateStr);
      germ.setHours(0, 0, 0, 0);
      target.setHours(0, 0, 0, 0);
      const diffTime = target - germ;
      return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    }

    function getFormattedDate(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      return `${y}-${m}-${d}`;
    }

    function setupEventListeners() {
      els.prevBtn.onclick = () => {
        STATE.currentViewDate.setMonth(STATE.currentViewDate.getMonth() - 1);
        renderCalendar();
      };
      els.nextBtn.onclick = () => {
        STATE.currentViewDate.setMonth(STATE.currentViewDate.getMonth() + 1);
        renderCalendar();
      };
      els.germinationInput.onchange = (e) => {
        STATE.germinationDate = e.target.value;
        saveData();
        renderCalendar();
      };
      els.modalTemp.oninput = updateVPDDisplay;
      els.modalRh.oninput = updateVPDDisplay;
      els.modalAddWaterBtn.onclick = () => {
        if (!STATE.selectedDate) return;
        STATE.data[STATE.selectedDate].water += 0.5;
        els.modalWaterDisplay.innerText = `${STATE.data[STATE.selectedDate].water.toFixed(1)} L`;
      };
      els.modalResetWaterBtn.onclick = () => {
        if (!STATE.selectedDate) return;
        STATE.data[STATE.selectedDate].water = 0;
        els.modalWaterDisplay.innerText = "0.0 L";
      };
      els.saveCloseBtn.onclick = saveAndClose;
      els.copyYesterdayBtn.onclick = copyFromYesterday;
      els.modalOverlay.onclick = (e) => {
        if (e.target === els.modalOverlay) closeModal();
      };
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && els.modalOverlay.classList.contains('active')) closeModal();
      });
      els.toggleSyncBtn.onclick = () => {
        const isVisible = els.syncContent.style.display !== 'none';
        els.syncContent.style.display = isVisible ? 'none' : 'block';
        els.toggleSyncBtn.innerText = isVisible ? 'SHOW' : 'HIDE';
      };
      els.injectBtn.onclick = injectFlightLog;
    }

    function setupMatrixRain() {
      const canvas = document.getElementById('matrix-bg');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const chars = '01';
      const fontSize = 14;
      const columns = canvas.width / fontSize;
      const drops = [];
      for (let x = 0; x < columns; x++) drops[x] = 1;
      function draw() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = '#0F0';
        ctx.font = fontSize + 'px monospace';
        for (let i = 0; i < drops.length; i++) {
          const text = chars.charAt(Math.floor(Math.random() * chars.length));
          ctx.fillText(text, i * fontSize, drops[i] * fontSize);
          if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
          drops[i]++;
        }
      }
      setInterval(draw, 50);
      window.onresize = () => {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
      };
    }

    init();
  </script>
</body>

</html>