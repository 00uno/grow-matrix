<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GROWOPS V5.0 | MATRIX NODE</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --matrix-green: #00FF41; --dark-bg: #0D0208; --dim-green: #008F11; --alert-red: #FF0055; }
        body { background-color: black; color: var(--matrix-green); font-family: 'Courier New', Courier, monospace; margin: 0; padding: 20px; overflow-x: hidden; }
        
        /* Matrix Header */
        header { border-bottom: 2px solid var(--matrix-green); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { margin: 0; text-shadow: 0 0 5px var(--matrix-green); letter-spacing: 2px; }
        .status { font-size: 12px; border: 1px solid var(--matrix-green); padding: 5px 10px; }
        
        /* Layout */
        .container { display: grid; grid-template-columns: 3fr 1fr; gap: 20px; height: 85vh; }
        
        /* Calendar Grid */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: var(--dim-green); border: 1px solid var(--matrix-green); }
        .day-cell { background: black; min-height: 100px; padding: 5px; cursor: pointer; transition: all 0.2s; position: relative; }
        .day-cell:hover { background: #001100; box-shadow: inset 0 0 10px var(--matrix-green); }
        .day-number { font-weight: bold; position: absolute; top: 5px; left: 5px; }
        .day-data { margin-top: 25px; font-size: 10px; line-height: 1.4; }
        .day-data div { margin-bottom: 2px; }
        
        /* Right Panel */
        .panel { border-left: 2px solid var(--matrix-green); padding-left: 20px; display: flex; flex-direction: column; gap: 20px; }
        .panel-box { border: 1px solid var(--dim-green); padding: 10px; }
        .panel-title { background: var(--dim-green); color: black; padding: 2px 5px; font-weight: bold; margin-bottom: 10px; display: inline-block; }
        
        /* Offline Sync Box */
        textarea.json-input { width: 100%; height: 100px; background: #001100; color: var(--matrix-green); border: 1px solid var(--matrix-green); font-family: monospace; font-size: 10px; resize: none; }
        button.btn-matrix { background: black; color: var(--matrix-green); border: 1px solid var(--matrix-green); padding: 10px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 5px; text-transform: uppercase; }
        button.btn-matrix:hover { background: var(--matrix-green); color: black; }

        /* Live Telemetry */
        #live-telemetry { font-size: 24px; text-align: center; border: 1px solid var(--matrix-green); padding: 15px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 5px var(--dim-green); } 50% { box-shadow: 0 0 15px var(--matrix-green); } 100% { box-shadow: 0 0 5px var(--dim-green); } }

        /* Modal (La Ficha) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: black; border: 2px solid var(--matrix-green); width: 90%; max-width: 500px; padding: 20px; position: relative; box-shadow: 0 0 30px var(--dim-green); }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: var(--alert-red); }
        
        /* Form Elements */
        label { display: block; margin-top: 10px; font-size: 12px; color: #88ff88; }
        input, select, textarea { width: 100%; background: #002200; border: 1px solid var(--dim-green); color: white; padding: 8px; box-sizing: border-box; font-family: monospace; }
        .vpd-display { font-size: 14px; margin-top: 5px; font-weight: bold; }
        
        /* Responsive */
        @media (max-width: 768px) { .container { grid-template-columns: 1fr; height: auto; } .calendar-grid { grid-template-columns: repeat(4, 1fr); } }
    </style>
</head>
<body>

    <header>
        <div>
            <h1>GROWOPS V5.0</h1>
            <div style="font-size: 10px; opacity: 0.7;">SYSTEM: ONLINE | USER: ADMIN</div>
        </div>
        <div id="connection-status" class="status">CONNECTING...</div>
    </header>

    <div class="container">
        <div class="calendar-wrapper">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <button class="btn-matrix" style="width:auto;" onclick="changeMonth(-1)">< PREV</button>
                <h2 id="current-month" style="margin:0;">NOVEMBER 2025</h2>
                <button class="btn-matrix" style="width:auto;" onclick="changeMonth(1)">NEXT ></button>
            </div>
            <div id="calendar" class="calendar-grid"></div>
        </div>

        <div class="panel">
            
            <div class="panel-box">
                <div class="panel-title">üî¥ LIVE TELEMETRY</div>
                <div id="live-telemetry">
                    WAITING FOR ESP32...
                </div>
            </div>

            <div class="panel-box">
                <div class="panel-title">üíæ OFFLINE SYNC</div>
                <textarea id="json-injection" class="json-input" placeholder="Paste ESP32 JSON logs here..."></textarea>
                <button class="btn-matrix" onclick="injectData()">INJECT FLIGHT LOG</button>
            </div>

            <div class="panel-box">
                <div class="panel-title">‚ÑπÔ∏è SYSTEM INFO</div>
                <div style="font-size: 10px;">
                    GERMINATION: 22 NOV 2025<br>
                    PHASE: VEGETATION<br>
                    TARGET VPD: 0.8 - 1.1 kPa
                </div>
            </div>
        </div>
    </div>

    <div id="dataModal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">√ó</span>
            <h2 id="modal-date-title" style="border-bottom: 1px solid var(--matrix-green); padding-bottom:10px;">DAY REPORT</h2>
            
            <input type="hidden" id="selected-date-key">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div>
                    <label>TEMP (¬∞C)</label>
                    <input type="number" id="input-temp" oninput="calculateVPD()">
                </div>
                <div>
                    <label>HUMIDITY (%)</label>
                    <input type="number" id="input-rh" oninput="calculateVPD()">
                </div>
            </div>
            <div id="vpd-result" class="vpd-display">VPD: -- kPa</div>

            <label>LIGHT (LUX)</label>
            <input type="number" id="input-lux" list="lux-presets">
            <datalist id="lux-presets">
                <option value="5000">Seedling Low</option>
                <option value="8000">Seedling High</option>
                <option value="15000">Veg Early</option>
                <option value="25000">Veg Late</option>
                <option value="45000">Flower Start</option>
                <option value="60000">Flower Peak</option>
            </datalist>

            <label>WATER (Liters)</label>
            <div style="display:flex; gap:5px;">
                <input type="number" id="input-water" step="0.1">
                <button class="btn-matrix" style="width:50px;" onclick="addWater(0.5)">+0.5</button>
            </div>

            <label>NOTES</label>
            <textarea id="input-notes" rows="3"></textarea>

            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-matrix" onclick="saveDayData()">SAVE DATA</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // TUS CLAVES DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyBzjkda5C3__QB8jglOQK79HDfvxVZ8iGQ",
            authDomain: "grow-matrix.firebaseapp.com",
            databaseURL: "https://grow-matrix-default-rtdb.firebaseio.com",
            projectId: "grow-matrix",
            storageBucket: "grow-matrix.firebasestorage.app",
            messagingSenderId: "1004789173992",
            appId: "1:1004789173992:web:0aa39431f84cd4937c435d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        let globalGrowData = {};
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();

        // 1. CONEXI√ìN Y ESCUCHA DE DATOS
        const statusDiv = document.getElementById('connection-status');
        const liveDiv = document.getElementById('live-telemetry');

        // Escuchar Base de Datos Principal
        onValue(ref(db, 'growData'), (snapshot) => {
            statusDiv.textContent = "[ FIREBASE: ONLINE ]";
            statusDiv.style.color = "#00FF41";
            statusDiv.style.borderColor = "#00FF41";
            globalGrowData = snapshot.val() || {};
            renderCalendar();
        }, (error) => {
            statusDiv.textContent = "[ FIREBASE: ERROR ]";
            statusDiv.style.color = "red";
        });

        // Escuchar Telemetr√≠a en Vivo (ESP32)
        onValue(ref(db, 'live_sensors'), (snapshot) => {
            const data = snapshot.val();
            if(data) {
                liveDiv.innerHTML = `
                    <div style="font-size:30px; color:white;">${data.temp}¬∞C</div>
                    <div style="color:cyan;">${data.rh}% RH</div>
                    <div style="font-size:12px; margin-top:5px; color:yellow;">‚ö° ${data.lux} LUX</div>
                `;
            }
        });

        // 2. L√ìGICA DEL CALENDARIO
        window.changeMonth = (delta) => {
            currentMonth += delta;
            if(currentMonth > 11) { currentMonth = 0; currentYear++; }
            if(currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
        }

        function renderCalendar() {
            const calDiv = document.getElementById('calendar');
            const monthTitle = document.getElementById('current-month');
            calDiv.innerHTML = "";
            
            const date = new Date(currentYear, currentMonth, 1);
            monthTitle.innerText = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }).toUpperCase();

            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const firstDayIndex = date.getDay(); // 0 = Sunday

            // Rellenar huecos vac√≠os antes del d√≠a 1
            for(let i=0; i<firstDayIndex; i++) {
                const empty = document.createElement('div');
                empty.className = 'day-cell';
                empty.style.opacity = '0.3';
                calDiv.appendChild(empty);
            }

            // Pintar d√≠as
            for(let i=1; i<=daysInMonth; i++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                const dayKey = `${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                
                let content = `<div class="day-number">${i}</div>`;
                
                // Si hay datos, pintarlos
                if(globalGrowData[dayKey]) {
                    const d = globalGrowData[dayKey];
                    content += `<div class="day-data">`;
                    if(d.temp) content += `<div style="color:white;">üå°Ô∏è ${d.temp}¬∞ | üíß ${d.rh}%</div>`;
                    if(d.water) content += `<div style="color:cyan;">üöø ${d.water}L</div>`;
                    if(d.lux) content += `<div style="color:yellow;">‚ö° ${d.lux}</div>`;
                    if(d.notes) content += `<div style="color:#aaa;">üìù ...</div>`;
                    content += `</div>`;
                    
                    // Borde rojo si VPD es peligroso (simple check)
                    if(d.temp && d.rh) {
                        // l√≥gica simple de alerta visual
                    }
                }

                cell.innerHTML = content;
                cell.onclick = () => openModal(dayKey);
                calDiv.appendChild(cell);
            }
        }

        // 3. MODAL & DATA ENTRY
        window.openModal = (dateKey) => {
            document.getElementById('dataModal').style.display = 'flex';
            document.getElementById('modal-date-title').innerText = "REPORT: " + dateKey;
            document.getElementById('selected-date-key').value = dateKey;

            // Limpiar o cargar datos existentes
            const d = globalGrowData[dateKey] || {};
            document.getElementById('input-temp').value = d.temp || '';
            document.getElementById('input-rh').value = d.rh || '';
            document.getElementById('input-lux').value = d.lux || '';
            document.getElementById('input-water').value = d.water || '';
            document.getElementById('input-notes').value = d.notes || '';
            calculateVPD();
        }

        window.closeModal = () => {
            document.getElementById('dataModal').style.display = 'none';
        }

        window.saveDayData = () => {
            const key = document.getElementById('selected-date-key').value;
            const data = {
                temp: document.getElementById('input-temp').value,
                rh: document.getElementById('input-rh').value,
                lux: document.getElementById('input-lux').value,
                water: document.getElementById('input-water').value,
                notes: document.getElementById('input-notes').value
            };
            
            // Guardar en Firebase
            update(ref(db, 'growData/' + key), data);
            closeModal();
        }

        window.addWater = (amount) => {
            const input = document.getElementById('input-water');
            let val = parseFloat(input.value) || 0;
            input.value = (val + amount).toFixed(1);
        }

        window.calculateVPD = () => {
            const T = parseFloat(document.getElementById('input-temp').value);
            const RH = parseFloat(document.getElementById('input-rh').value);
            const div = document.getElementById('vpd-result');
            
            if(!T || !RH) { div.innerText = "VPD: --"; return; }

            // Formula VPD
            const svp = 0.61078 * Math.exp((17.27 * T) / (T + 237.3));
            const vpd = svp * (1 - (RH / 100));
            
            div.innerText = `VPD: ${vpd.toFixed(2)} kPa`;
            
            if(vpd < 0.4 || vpd > 1.6) { div.style.color = "red"; }
            else if(vpd >= 0.8 && vpd <= 1.2) { div.style.color = "#00FF41"; div.innerText += " (PERFECT)"; }
            else { div.style.color = "yellow"; }
        }

        // 4. INYECCI√ìN DE DATOS (OFFLINE SYNC)
        window.injectData = () => {
            const rawJson = document.getElementById('json-injection').value;
            try {
                const logs = JSON.parse(rawJson);
                if(!Array.isArray(logs)) throw new Error("Format must be an array []");
                
                const updates = {};
                logs.forEach(log => {
                    // Asumimos formato log: {date: "2025-11-24", temp: 24, rh: 60...}
                    if(log.date) {
                        updates['growData/' + log.date + '/temp'] = log.temp;
                        updates['growData/' + log.date + '/rh'] = log.rh;
                        if(log.lux) updates['growData/' + log.date + '/lux'] = log.lux;
                    }
                });
                
                update(ref(db), updates);
                alert("‚úÖ INJECTION SUCCESSFUL: " + logs.length + " RECORDS");
                document.getElementById('json-injection').value = "";
                
            } catch(e) {
                alert("‚ùå ERROR: Invalid JSON format. " + e.message);
            }
        }

        // Init Calendar
        renderCalendar();
    </script>
</body>
</html>